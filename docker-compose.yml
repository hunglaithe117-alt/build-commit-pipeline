version: "3.9"

services:
  # api:
  #   build:
  #     context: ./backend
  #   container_name: build_commit_api
  #   command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
  #   environment:
  #     PIPELINE_CONFIG: /app/config/pipeline.yml
  #   volumes:
  #     - ./backend:/app
  #     - ./config/pipeline.yml:/app/config/pipeline.yml:ro
  #     - ../sonar-scan:/app/sonar-scan:ro
  #     - ./data:/app/data
  #     - ../sonar-scan:/app/sonar-scan:ro
  #   depends_on:
  #     - redis
  #     - mongo
  #   ports:
  #     - "8000:8000"

  # worker:
  #   build:
  #     context: ./backend
  #   container_name: build_commit_worker
  #   command: celery -A app.celery_app.celery_app worker --loglevel=info
  #   environment:
  #     PIPELINE_CONFIG: /app/config/pipeline.yml
  #   volumes:
  #     - ./backend:/app
  #     - ./config/pipeline.yml:/app/config/pipeline.yml:ro
  #     - ./data:/app/data
  #     - ../sonar-scan:/app/sonar-scan:ro
  #   depends_on:
  #     - redis
  #     - mongo

  # beat:
  #   build:
  #     context: ./backend
  #   container_name: build_commit_beat
  #   command: celery -A app.celery_app.celery_app beat --loglevel=info
  #   environment:
  #     PIPELINE_CONFIG: /app/config/pipeline.yml
  #   volumes:
  #     - ./backend:/app
  #     - ./config/pipeline.yml:/app/config/pipeline.yml:ro
  #   depends_on:
  #     - redis
  #     - mongo

  # frontend:
  #   build:
  #     context: ./frontend
  #   container_name: build_commit_frontend
  #   command: npm run dev -- --hostname 0.0.0.0 --port 3000
  #   environment:
  #     NEXT_PUBLIC_API_BASE_URL: http://localhost:8000
  #   volumes:
  #     - ./frontend:/app
  #   depends_on:
  #     - api
  #   ports:
  #     - "3000:3000"

  redis:
    image: redis:7.2-alpine
    container_name: build_commit_redis
    ports:
      - "6379:6379"

  mongo:
    image: mongo:6.0
    container_name: build_commit_mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: travis
      MONGO_INITDB_ROOT_PASSWORD: travis
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
  
  sonarqube1:
    image: sonarqube:latest
    container_name: sonarqube1
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
    volumes:
      - sonarqube1_data:/opt/sonarqube/data
      - sonarqube1_extensions:/opt/sonarqube/extensions
      - sonarqube1_logs:/opt/sonarqube/logs
    ports:
      - "9001:9000"
    networks:
      - sonar-net

  sonarqube2:
    image: sonarqube:latest
    container_name: sonarqube2
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
    volumes:
      - sonarqube2_data:/opt/sonarqube/data
      - sonarqube2_extensions:/opt/sonarqube/extensions
      - sonarqube2_logs:/opt/sonarqube/logs
    ports:
      - "9002:9000"
    networks:
      - sonar-net
  db:
    image: postgres:15-alpine
    container_name: sonar_db
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonar
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sonar-net
volumes:
  mongo_data:
  postgres_data:
  sonarqube1_data:
  sonarqube1_extensions:
  sonarqube1_logs:
  sonarqube2_data:
  sonarqube2_extensions:
  sonarqube2_logs: